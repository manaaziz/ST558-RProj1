---
title: "ST558 Project I"
author: "Mana Azizsoltani"
date: "9/4/2020"
output: rmarkdown::github_document
---

```{r setup, include=FALSE}
# Load necessary packages
library(knitr)
library(tidyverse)
library(parallel)
library(rmarkdown)
library(bigrquery)
library(DBI)
library(RSQLite)
library(httr)
library(jsonlite)
library(RCurl)
```


```{r funcs}
# Write URL to access the NHL Records API
getRecords <- function(endpoint, teamID = NULL, teamName = NULL){
  base <- "https://records.nhl.com/site/api"
  table <- endpoint
  if (!is.null(teamName) & is.null(teamID)) {
    full_url <- full_url <- paste0(base, "/", table)
    data <- fromJSON(full_url, flatten = TRUE)$data %>% filter(franchiseName == teamName)
  } else if(!is.null(teamID) & is.null(teamName)) {
      full_url <- paste0(base, "/", table, "?cayenneExp=franchiseId=", teamID)
      data <-fromJSON(full_url, flatten = TRUE)$data
  } else if(is.null(teamID) & is.null(teamName)) {
      full_url <- paste0(base, "/", table)
      data <-fromJSON(full_url, flatten = TRUE)$data
    }
  return(data)
}

# write the function for the NHL Stats API
getStats <- function(modifier=NULL){
  base <- "https://statsapi.web.nhl.com/api/v1/teams"
  if(!is.null(modifier)){
    full_url <- paste0(base, modifier)
    data <- fromJSON(full_url, flatten = TRUE)$teams
  } else {
    data <- fromJSON(base, flatten = TRUE)$teams
  }
  return(data)
}

# Write the wrapper function
pullData <- function(api = c("stats", "records"), endpoint = NULL, 
                     teamName = NULL, teamID = NULL, modifier = NULL){
  if(api == "stats"){
    data <- getStats(modifier = modifier)
    }
  if(api == "records"){
    data <- getRecords(endpoint = endpoint, teamID  = teamID, teamName = teamName)
    }
  return(data)
}

```

```{r VGKdata}
# read in the roster of the VGK for the 2017/2018 season
rosters <- pullData(api = "stats", modifier = "?expand=team.roster&season=20172018")
VGKrost <- as.data.frame(rosters[[30]][[31]])
VGKrost <- VGKrost %>% filter(position.code != "G") %>% select(-person.link)

# Get the stats for each individual player.
ppl <- VGKrost$person.id %>% as.vector(mode = "character")
temp <- data.frame()
df.stats <- data.frame()
for (i in 1:length(ppl)){
  url <- paste0("https://statsapi.web.nhl.com/api/v1/people/", ppl[i],
                "/stats?stats=statsSingleSeason&season=20172018")
  temp <- fromJSON(url, flatten = TRUE)$stats$splits %>% as.data.frame()
  temp$person.id <- as.numeric(ppl[i])
  df.stats <- bind_rows(df.stats, temp)
}

ppl <- VGKrost$person.id %>% as.vector(mode = "character")
temp <- data.frame()
df.ppl <- data.frame()
for (i in 1:length(ppl)){
  url <- paste0("https://statsapi.web.nhl.com/api/v1/people/", ppl[i])
  temp <- fromJSON(url, flatten = TRUE)$people %>% as.data.frame()
  df.ppl <- bind_rows(df.ppl, temp)
}

# Join the three data sets
df.ppl <- df.ppl %>% rename(person.id = id)
dfd <- inner_join(VGKrost, df.ppl, by = "person.id")
df <- inner_join(dfd, df.stats)

# Get rid of redundant rows
df <- df %>% select(-ends_with("link"), -starts_with("primary"), -ends_with("TimeOnIce"))

# Add new variables
df <- df %>% mutate(goalsPerGame = stat.goals/stat.games, 
                    assistsPerGame = stat.assists/stat.games,
                    shotsPerGame = stat.shots/stat.games,
                    hitsPerGame = stat.hits/stat.games)
```

```{r contTbl}
# Create contingency tables
table(df$position.name) %>% kable(caption= "Number of players in each field position", 
                                  col.names = c("Position", "Frequency"))
table(df$)










```

```{r test}
players <- fromJSON("https://statsapi.web.nhl.com/api/v1/roster/", flatten = TRUE)




d <- pullData(api = "records", endpoint = "franchise-goalie-records", teamName = "Boston Bruins")

d <- getStats("?expand=team.roster&season=20182019")
d <- getStats("?expand=team.roster&season=20102011")
d <- getStats("?stats=statsSingleSeason&season=20182019")
### TEST STUFF

full_url <- "https://statsapi.web.nhl.com/api/v1/teams?expand=person.names"
full_url <- "https://statsapi.web.nhl.com/api/v1/teams?expand=team.stats"
d <- fromJSON(full_url, flatten = TRUE)$teams


d <- getStats(modifier = "?expand=team.stats")

base <- "https://statsapi.web.nhl.com/api/v1/teams"
d <- fromJSON(full_url, flatten = TRUE)
  
base <- "https://records.nhl.com/site/api"
table <- "franchise"
attr <- "pikachu/"
full_url <- paste0(base, "/", table)
data <-fromJSON(full_url, flatten = TRUE)$data

table <-"franchise-team-totals"
full_url <- paste0(base, "/", table)
data <-fromJSON(full_url, flatten = TRUE)$data

table <- "franchise-season-records"
full_url <- paste0(base, "/", table)
data <-fromJSON(full_url, flatten = TRUE)$data %>% filter(franchiseName=="Vegas Golden Knights")

table <- "franchise-goalie-records"
full_url <- paste0(base, "/", table, "?cayenneExp=franchiseId=", id)
data <- fromJSON(full_url, flatten = TRUE)$data

table <- "franchise-season-records"
full_url <- paste0(base, "/", table, "?cayenneExp=franchiseId=", id)
data <-fromJSON(full_url, flatten = TRUE)$data

```